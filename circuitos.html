<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Simulador de Circuitos El√©tricos</title>
  <style>
    * { 
      box-sizing: border-box; 
      margin:0; 
      padding:0;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    body { 
      font-family: system-ui, Segoe UI, Roboto, Arial;
      background: #071026; 
      color: #e6eef8;
      height: 100vh;
      height: 100dvh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    header {
      padding: 8px 12px;
      background: #061226;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 5px;
      min-height: 50px;
    }
    
    .header-content {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 0;
    }
    
    h1 {
      font-size: clamp(14px, 4vw, 16px);
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .small {
      font-size: clamp(10px, 2.5vw, 12px);
      color: #bcd6ff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: #e6eef8;
      font-size: 20px;
      padding: 5px;
      cursor: pointer;
    }
    
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
      flex-direction: column;
    }
    
    #toolbar {
      background: #041224;
      padding: 8px;
      display: flex;
      gap: 6px;
      overflow-x: auto;
      overflow-y: hidden;
      border-bottom: 1px solid #1d5676;
      min-height: 60px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    
    #toolbar::-webkit-scrollbar {
      display: none;
    }
    
    #toolbar button {
      background: #0b3b5a;
      border: 1px solid #1d5676;
      color: #e6eef8;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
      font-size: 11px;
      min-height: 44px;
      min-width: 60px;
      flex-shrink: 0;
    }
    
    #toolbar button:active {
      background: #0d4a6e;
      transform: scale(0.95);
    }
    
    #toolbar button.active { 
      background: #1e7a3a;
    }
    
    .tool-icon {
      font-size: 16px;
      width: 20px;
      height: 20px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #canvas-container {
      flex: 1;
      position: relative;
      background: linear-gradient(#082033, #04121b);
      overflow: hidden;
      touch-action: none;
    }
    
    #work-area {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transform-origin: 0 0;
      transition: transform 0.2s;
    }
    
    .component {
      position: absolute;
      width: 60px;
      height: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 10px;
      border-radius: 6px;
      user-select: none;
      cursor: move;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: transform 0.1s, box-shadow 0.1s;
      z-index: 10;
    }
    
    .component:active {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
      z-index: 20;
    }
    
    .component-icon {
      font-size: 14px;
      margin-bottom: 1px;
    }
    
    .resistor  { background: #e67e22; border: 2px solid #d35400; }
    .voltage   { background: #c0392b; border: 2px solid #a93226; }
    .current   { background: #8e44ad; border: 2px solid #7d3c98; }
    .capacitor { background: #16a085; border: 2px solid #138d75; }
    .inductor  { background: #27ae60; border: 2px solid #229954; }
    .diode     { background: #d35400; border: 2px solid #ba4a00; }
    .lamp      { background: #f1c40f; color: #000; border: 2px solid #d4ac0d; }
    .switch    { background: #2980b9; border: 2px solid #2471a3; }
    .ground    { background: #7f8c8d; border: 2px solid #707b7c; }
    
    .socket {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #2c3e50;
      border: 2px solid #ecf0f1;
      border-radius: 50%;
      cursor: crosshair;
      z-index: 15;
    }
    
    .pin1 { left: -5px; top: 10px; }
    .pin2 { right: -5px; top: 10px; }
    
    .node {
      position: absolute;
      width: 12px;
      height: 12px;
      background: rgba(52,152,219,0.8);
      border: 2px solid #3498db;
      border-radius: 50%;
      cursor: crosshair;
      z-index: 5;
    }
    
    svg#wires {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    
    #mobile-controls {
      position: absolute;
      bottom: 15px;
      left: 0;
      right: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 30;
      padding: 0 15px;
    }
    
    .actions-row {
      display: flex;
      gap: 8px;
      justify-content: space-between;
    }
    
    #actions button {
      background: #0b3b5a;
      color: #e6eef8;
      border: 1px solid #1d5676;
      padding: 10px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      min-height: 44px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      flex: 1;
      min-width: 0;
    }
    
    #actions button:active {
      background: #0d4a6e;
      transform: scale(0.98);
    }
    
    .action-icon {
      font-size: 14px;
    }
    
    .zoom-controls {
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    
    .zoom-controls button {
      background: rgba(11, 59, 90, 0.9);
      color: #e6eef8;
      border: 1px solid #1d5676;
      width: 44px;
      height: 44px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .zoom-controls button:active {
      background: rgba(13, 74, 110, 0.9);
      transform: scale(0.95);
    }
    
    #output {
      position: absolute;
      top: 15px;
      left: 15px;
      right: 15px;
      background: rgba(4, 18, 36, 0.95);
      padding: 12px;
      border: 1px solid #1d5676;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 40vh;
      overflow: auto;
      border-radius: 6px;
      z-index: 30;
      font-size: 11px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      -webkit-overflow-scrolling: touch;
    }
    
    #calcPanel {
      position: absolute;
      top: 50%;
      left: 15px;
      right: 15px;
      transform: translateY(-50%);
      background: rgba(4, 18, 36, 0.98);
      border: 1px solid #1d5676;
      padding: 15px;
      font-family: monospace;
      white-space: pre-wrap;
      display: none;
      z-index: 100;
      max-height: 70vh;
      overflow: auto;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      -webkit-overflow-scrolling: touch;
      font-size: 11px;
    }
    
    #tooltip {
      position: absolute;
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 11px;
      pointer-events: none;
      display: none;
      white-space: nowrap;
      z-index: 1000;
      border: 1px solid #1d5676;
      max-width: 200px;
    }
    
    .mobile-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .mobile-dialog {
      background: #041224;
      border: 1px solid #1d5676;
      border-radius: 10px;
      padding: 20px;
      max-width: 300px;
      width: 100%;
    }
    
    .mobile-dialog h3 {
      margin-bottom: 15px;
      text-align: center;
    }
    
    .mobile-dialog input {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #1d5676;
      border-radius: 6px;
      background: #0b3b5a;
      color: #e6eef8;
      font-size: 16px;
    }
    
    .dialog-buttons {
      display: flex;
      gap: 10px;
    }
    
    .dialog-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .dialog-confirm {
      background: #1e7a3a;
      color: white;
    }
    
    .dialog-cancel {
      background: #7f8c8d;
      color: white;
    }
    
    /* Melhorias para telas muito pequenas */
    @media (max-width: 360px) {
      #toolbar button {
        min-width: 55px;
        padding: 6px 8px;
        font-size: 10px;
      }
      
      .tool-icon {
        font-size: 14px;
      }
      
      #actions button {
        padding: 8px 10px;
        font-size: 11px;
      }
      
      .component {
        width: 50px;
        height: 25px;
        font-size: 9px;
      }
      
      .component-icon {
        font-size: 12px;
      }
    }
    
    /* Para tablets e telas maiores */
    @media (min-width: 768px) {
      .main-container {
        flex-direction: row;
      }
      
      #toolbar {
        width: 200px;
        flex-direction: column;
        overflow-y: auto;
        overflow-x: hidden;
        border-right: 1px solid #1d5676;
        border-bottom: none;
        min-height: auto;
      }
      
      #toolbar button {
        flex-direction: row;
        text-align: left;
        min-width: auto;
        font-size: 12px;
      }
      
      #mobile-controls {
        left: 15px;
        right: auto;
        bottom: 15px;
        flex-direction: row;
        align-items: flex-end;
      }
      
      .actions-row {
        flex-direction: column;
      }
      
      .zoom-controls {
        flex-direction: column;
        margin-left: 10px;
      }
      
      #output {
        left: auto;
        right: 15px;
        width: 320px;
      }
      
      #calcPanel {
        left: auto;
        right: 15px;
        width: 320px;
        transform: none;
        top: 60px;
      }
    }
    
    /* Para telas muito grandes */
    @media (min-width: 1024px) {
      #toolbar {
        width: 240px;
      }
      
      #toolbar button {
        font-size: 14px;
        padding: 10px 12px;
      }
    }

    .pulse {
      animation: pulse 0.5s ease-in-out;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .wire-highlight {
      filter: drop-shadow(0 0 4px #0fa3ff);
    }
    
    .wire-pending {
      stroke-dasharray: 5,5;
      stroke: #0fa3ff;
    }
    
    .electron {
      position: absolute;
      width: 6px;
      height: 6px;
      background: #0fa3ff;
      border-radius: 50%;
      pointer-events: none;
      z-index: 2;
      box-shadow: 0 0 8px #0fa3ff;
      opacity: 0;
    }
    
    .electron-flow {
      animation: electronFlow 2s linear infinite;
    }
    
    @keyframes electronFlow {
      0% {
        transform: translateX(0) translateY(0);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateX(var(--tx)) translateY(var(--ty));
        opacity: 0;
      }
    }
    
    .lamp-light {
      position: absolute;
      border-radius: 50%;
      pointer-events: none;
      z-index: 1;
      opacity: 0;
      transition: opacity 0.5s;
    }
    
    .lamp-on .lamp-light {
      opacity: 0.7;
      animation: lampGlow 1.5s ease-in-out infinite alternate;
    }
    
    @keyframes lampGlow {
      0% {
        box-shadow: 0 0 20px 10px #f1c40f;
      }
      100% {
        box-shadow: 0 0 30px 15px #f1c40f;
      }
    }
    
    .spark {
      position: absolute;
      width: 4px;
      height: 4px;
      background: #ff9900;
      border-radius: 50%;
      pointer-events: none;
      z-index: 3;
      box-shadow: 0 0 6px #ff9900;
      opacity: 0;
    }
    
    .spark-effect {
      animation: spark 0.3s ease-out;
    }
    
    @keyframes spark {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      100% {
        transform: scale(3);
        opacity: 0;
      }
    }
  </style>
</head>
<body>

  <header>
    <div class="header-content">
      <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
      <h1>Simulador de Circuitos</h1>
    </div>
    <div class="small">Toque para adicionar ‚Ä¢ Conecte componentes</div>
  </header>

  <div class="main-container">
    <div id="toolbar">
      <button data-tool="select" class="active">
        <span class="tool-icon">‚Ü¶</span> Selecionar
      </button>
      <button data-tool="resistor">
        <span class="tool-icon">‚èö</span> Resistor
      </button>
      <button data-tool="voltage">
        <span class="tool-icon">‚éì</span> Fonte V
      </button>
      <button data-tool="current">
        <span class="tool-icon">‚éî</span> Fonte I
      </button>
      <button data-tool="capacitor">
        <span class="tool-icon">‚éè</span> Capacitor
      </button>
      <button data-tool="inductor">
        <span class="tool-icon">‚éë</span> Indutor
      </button>
      <button data-tool="diode">
        <span class="tool-icon">‚Ü¶</span> Diodo
      </button>
      <button data-tool="lamp">
        <span class="tool-icon">‚óã</span> L√¢mpada
      </button>
      <button data-tool="switch">
        <span class="tool-icon">‚≠ò</span> Interruptor
      </button>
      <button data-tool="ground">
        <span class="tool-icon">‚èö</span> Terra
      </button>
      <button data-tool="wire">
        <span class="tool-icon">‚û∞</span> Fio
      </button>
      <button data-tool="delete">
        <span class="tool-icon">üóë</span> Excluir
      </button>
    </div>

    <div id="canvas-container">
      <div id="work-area"></div>
      <svg id="wires"></svg>
      
      <div id="mobile-controls">
        <div class="actions-row" id="actions">
          <button id="btnSim">
            <span class="action-icon">‚ö°</span> Simular
          </button>
          <button id="btnShowCalc">
            <span class="action-icon">üìä</span> C√°lculos
          </button>
          <button id="btnClearAll">
            <span class="action-icon">üóë</span> Limpar
          </button>
          <button id="btnToggleAnimation">
            <span class="action-icon">üé¨</span> Anima√ß√£o
          </button>
        </div>
        
        <div class="zoom-controls">
          <button id="btnZoomIn">+</button>
          <button id="btnZoomOut">-</button>
          <button id="btnResetView">‚ü≤</button>
        </div>
      </div>
      
      <div id="output">
        Bem-vindo ao Simulador de Circuitos!

Instru√ß√µes:
1. Toque em um componente na barra
2. Toque na √°rea para adicionar
3. Use "Fio" para conectar
4. Toque em "Simular" para analisar

Dica: Toque duplo em interruptores e diodos para alterar estado.
      </div>
      
      <div id="calcPanel">
        <strong>F√≥rmulas Utilizadas</strong>
        <pre>
// An√°lise de Circuito S√©rie
// -------------------------

1. Resist√™ncia Total (Rtot):
   Rtot = Œ£ R_i

2. Lei de Ohm Geral:
   I = (Vfonte - Œ£ Vdiodos) / Rtot

3. Queda de Tens√£o:
   - Resistor: V = I √ó R
   - L√¢mpada: V = I √ó R
   - Diodo (forward): V = Vf
   - Capacitor (DC): V = Vfonte
   - Indutor (DC): V = 0

4. Pot√™ncia Dissipada:
   P = V √ó I
        </pre>
      </div>
    </div>
  </div>

  <div id="tooltip"></div>

  <!-- Overlay para di√°logos em mobile -->
  <div class="mobile-overlay" id="mobileOverlay">
    <div class="mobile-dialog">
      <h3 id="dialogTitle">Adicionar Componente</h3>
      <input type="text" id="dialogInput" placeholder="Valor">
      <div class="dialog-buttons">
        <button class="dialog-cancel" id="dialogCancel">Cancelar</button>
        <button class="dialog-confirm" id="dialogConfirm">OK</button>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const toolbar = document.getElementById('toolbar');
    const workArea = document.getElementById('work-area');
    const svg = document.getElementById('wires');
    const btnSim = document.getElementById('btnSim');
    const btnShowCalc = document.getElementById('btnShowCalc');
    const btnClearAll = document.getElementById('btnClearAll');
    const btnToggleAnimation = document.getElementById('btnToggleAnimation');
    const btnZoomIn = document.getElementById('btnZoomIn');
    const btnZoomOut = document.getElementById('btnZoomOut');
    const btnResetView = document.getElementById('btnResetView');
    const output = document.getElementById('output');
    const calcPanel = document.getElementById('calcPanel');
    const tooltip = document.getElementById('tooltip');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileOverlay = document.getElementById('mobileOverlay');
    const dialogTitle = document.getElementById('dialogTitle');
    const dialogInput = document.getElementById('dialogInput');
    const dialogCancel = document.getElementById('dialogCancel');
    const dialogConfirm = document.getElementById('dialogConfirm');

    let tool = 'select';
    let compCount = 0;
    let dragObj = null;
    let offsetX = 0, offsetY = 0;
    let wireStart = null;
    let pendingWire = null;
    const connections = [];
    let scale = 1;
    let translateX = 0, translateY = 0;
    let isPanning = false;
    let startX, startY;
    let animationEnabled = true;
    let animationInterval = null;
    let currentSimulation = null;
    let pendingComponent = null;
    let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    let lastTouchTime = 0;

    // Configura√ß√£o de √≠cones para componentes
    const componentIcons = {
      resistor: '‚èö',
      voltage: '‚éì',
      current: '‚éî',
      capacitor: '‚éè',
      inductor: '‚éë',
      diode: '‚Ü¶',
      lamp: '‚óã',
      switch: '‚≠ò',
      ground: '‚èö'
    };

    // Menu mobile para telas pequenas
    if (isMobile && window.innerWidth < 768) {
      mobileMenuBtn.style.display = 'block';
      mobileMenuBtn.onclick = () => {
        toolbar.style.display = toolbar.style.display === 'none' ? 'flex' : 'none';
      };
    }

    // Atualizar ferramenta ativa
    toolbar.addEventListener('click', e => {
      if (e.target.tagName === 'BUTTON' || e.target.parentElement.tagName === 'BUTTON') {
        const button = e.target.tagName === 'BUTTON' ? e.target : e.target.parentElement;
        tool = button.dataset.tool;
        Array.from(toolbar.children).forEach(b => b.classList.remove('active'));
        button.classList.add('active');
        
        // Limpar fio pendente ao mudar de ferramenta
        if (pendingWire) {
          pendingWire.remove();
          pendingWire = null;
        }
        wireStart = null;
        
        // Feedback visual
        button.classList.add('pulse');
        setTimeout(() => button.classList.remove('pulse'), 500);
        
        // Esconder toolbar em mobile ap√≥s sele√ß√£o
        if (isMobile && window.innerWidth < 768) {
          toolbar.style.display = 'none';
        }
      }
    });

    // Controles de zoom otimizados para touch
    btnZoomIn.onclick = () => {
      scale = Math.min(scale * 1.2, 3);
      updateWorkAreaTransform();
    };

    btnZoomOut.onclick = () => {
      scale = Math.max(scale / 1.2, 0.3);
      updateWorkAreaTransform();
    };

    btnResetView.onclick = () => {
      scale = 1;
      translateX = 0;
      translateY = 0;
      updateWorkAreaTransform();
    };

    function updateWorkAreaTransform() {
      workArea.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
      redrawWires();
    }

    // Di√°logo mobile para entrada de valores
    function showMobileDialog(title, defaultValue, callback) {
      dialogTitle.textContent = title;
      dialogInput.value = defaultValue;
      dialogInput.focus();
      mobileOverlay.style.display = 'flex';
      
      const confirmHandler = () => {
        mobileOverlay.style.display = 'none';
        callback(dialogInput.value);
        cleanupDialog();
      };
      
      const cancelHandler = () => {
        mobileOverlay.style.display = 'none';
        cleanupDialog();
      };
      
      const cleanupDialog = () => {
        dialogConfirm.removeEventListener('click', confirmHandler);
        dialogCancel.removeEventListener('click', cancelHandler);
      };
      
      dialogConfirm.addEventListener('click', confirmHandler);
      dialogCancel.addEventListener('click', cancelHandler);
    }

    // Mostrar/ocultar painel de c√°lculos
    btnShowCalc.onclick = () => {
      calcPanel.style.display = calcPanel.style.display === 'block' ? 'none' : 'block';
    };

    // Limpar tudo
    btnClearAll.onclick = () => {
      if (confirm('Tem certeza que deseja limpar todo o circuito?')) {
        workArea.innerHTML = '';
        svg.innerHTML = '';
        connections.length = 0;
        compCount = 0;
        stopAnimations();
        output.textContent = 'Circuito limpo. Adicione novos componentes para come√ßar.';
      }
    };

    // Controle de anima√ß√£o
    btnToggleAnimation.onclick = () => {
      animationEnabled = !animationEnabled;
      btnToggleAnimation.innerHTML = `<span class="action-icon">üé¨</span> ${animationEnabled ? 'Anima√ß√£o' : 'Pausada'}`;
      
      if (animationEnabled && currentSimulation) {
        startAnimations(currentSimulation);
      } else {
        stopAnimations();
      }
    };

    // Eventos de toque otimizados para mobile
    workArea.addEventListener('touchstart', handleTouchStart, { passive: false });
    workArea.addEventListener('touchmove', handleTouchMove, { passive: false });
    workArea.addEventListener('touchend', handleTouchEnd);
    
    workArea.addEventListener('mousedown', handleMouseDown);
    workArea.addEventListener('mousemove', handleMouseMove);
    workArea.addEventListener('mouseup', handleMouseUp);
    
    document.addEventListener('mousemove', handleGlobalMouseMove);
    document.addEventListener('mouseup', handleGlobalMouseUp);

    function handleTouchStart(e) {
      e.preventDefault();
      if (e.touches.length > 1) {
        // Zoom com dois dedos
        isPanning = true;
        return;
      }
      
      const touch = e.touches[0];
      const rect = workArea.getBoundingClientRect();
      const x = (touch.clientX - rect.left - translateX) / scale;
      const y = (touch.clientY - rect.top - translateY) / scale;
      
      handleInteractionStart(x, y, document.elementFromPoint(touch.clientX, touch.clientY));
    }

    function handleTouchMove(e) {
      e.preventDefault();
      if (e.touches.length > 1 || !dragObj) return;
      
      const touch = e.touches[0];
      const rect = workArea.getBoundingClientRect();
      let x = (touch.clientX - rect.left - offsetX) / scale;
      let y = (touch.clientY - rect.top - offsetY) / scale;
      
      // Limitar movimento dentro da √°rea de trabalho
      const maxX = (workArea.parentElement.clientWidth / scale) - 60;
      const maxY = (workArea.parentElement.clientHeight / scale) - 30;
      
      x = Math.max(0, Math.min(maxX, x));
      y = Math.max(0, Math.min(maxY, y));
      
      if (dragObj) {
        dragObj.style.left = x + 'px';
        dragObj.style.top = y + 'px';
        redrawWires();
      }
    }

    function handleTouchEnd(e) {
      dragObj = null;
      isPanning = false;
    }

    function handleMouseDown(e) {
      e.preventDefault();
      const rect = workArea.getBoundingClientRect();
      const x = (e.clientX - rect.left - translateX) / scale;
      const y = (e.clientY - rect.top - translateY) / scale;
      
      handleInteractionStart(x, y, e.target);
    }

    function handleInteractionStart(x, y, target) {
      if (tool === 'delete') {
        if (target.classList.contains('component')) removeComponent(target);
        if (target.classList.contains('node')) removeNode(target);
        if (target.classList.contains('socket')) removeConnectionsFromSocket(target);
        return;
      }

      if (['resistor','voltage','current','capacitor','inductor',
           'diode','lamp','switch','ground'].includes(tool)) {
        pendingComponent = { type: tool, x, y };
        
        const labels = {
          resistor: 'Resist√™ncia (Œ©):', 
          voltage: 'Tens√£o (V):',
          current: 'Corrente (A):', 
          capacitor: 'Capacit√¢ncia (F):',
          inductor: 'Indut√¢ncia (H):', 
          diode: 'Vf do Diodo (V):',
          lamp: 'Resist√™ncia L√¢mpada (Œ©):',
          switch: 'Estado inicial (open/closed):',
          ground: 'Tens√£o Terra (V):'
        };
        
        const defaultValues = {
          resistor: '100',
          voltage: '12', 
          current: '1',
          capacitor: '0.0001',
          inductor: '0.001',
          diode: '0.7',
          lamp: '50',
          switch: 'closed',
          ground: '0'
        };
        
        if (isMobile) {
          showMobileDialog(labels[tool], defaultValues[tool], (value) => {
            if (value !== null && value !== '') {
              addComponent(tool, value, x-30, y-15);
            }
          });
        } else {
          let val = tool === 'switch' ? 
            prompt('Estado inicial (open/closed):', 'closed') :
            prompt(labels[tool], defaultValues[tool]);
          if (val !== null && val !== '') {
            addComponent(tool, val, x-30, y-15);
          }
        }
        return;
      }

      if (tool === 'wire') {
        handleWireTool(target, x, y);
        return;
      }

      if (tool === 'select') {
        if (target.classList.contains('component') || target.classList.contains('node')) {
          dragObj = target;
          const r = target.getBoundingClientRect();
          offsetX = (event.touches ? event.touches[0].clientX : event.clientX) - r.left;
          offsetY = (event.touches ? event.touches[0].clientY : event.clientY) - r.top;
        } else {
          // Iniciar panning
          isPanning = true;
          startX = (event.touches ? event.touches[0].clientX : event.clientX) - translateX;
          startY = (event.touches ? event.touches[0].clientY : event.clientY) - translateY;
        }
      }
    }

    function handleWireTool(target, x, y) {
      let endpoint = null;
      
      // Verificar se clicou em um socket ou n√≥
      if (target.classList.contains('socket') || target.classList.contains('node')) {
        endpoint = target;
      } 
      // Se n√£o clicou em um ponto de conex√£o, criar um n√≥
      else {
        const node = document.createElement('div');
        node.className = 'node';
        node.style.left = (x-6)+'px';
        node.style.top = (y-6)+'px';
        workArea.appendChild(node);
        endpoint = node;
      }
      
      if (!wireStart) {
        // Iniciar uma nova conex√£o
        wireStart = endpoint;
        wireStart.style.boxShadow = '0 0 0 2px #0fa3ff';
        
        // Criar linha tempor√°ria
        pendingWire = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        pendingWire.setAttribute('stroke', '#0fa3ff');
        pendingWire.setAttribute('stroke-width', '2');
        pendingWire.setAttribute('stroke-dasharray', '5,5');
        pendingWire.setAttribute('class', 'wire-pending');
        svg.appendChild(pendingWire);
      } else if (wireStart !== endpoint) {
        // Completar a conex√£o
        connectPoints(wireStart, endpoint);
        wireStart.style.boxShadow = '';
        wireStart = null;
        
        if (pendingWire) {
          pendingWire.remove();
          pendingWire = null;
        }
      }
    }

    function handleMouseMove(e) {
      const rect = workArea.getBoundingClientRect();
      const x = (e.clientX - rect.left - translateX) / scale;
      const y = (e.clientY - rect.top - translateY) / scale;
      
      // Atualizar linha tempor√°ria durante conex√£o
      if (pendingWire && wireStart) {
        const startRect = wireStart.getBoundingClientRect();
        const startX = startRect.left + startRect.width/2 - rect.left;
        const startY = startRect.top + startRect.height/2 - rect.top;
        
        pendingWire.setAttribute('x1', startX);
        pendingWire.setAttribute('y1', startY);
        pendingWire.setAttribute('x2', e.clientX - rect.left);
        pendingWire.setAttribute('y2', e.clientY - rect.top);
      }
      
      // Atualizar tooltip
      if (tooltip.style.display === 'block') {
        tooltip.style.left = e.pageX + 10 + 'px';
        tooltip.style.top = e.pageY + 10 + 'px';
      }
    }

    function handleGlobalMouseMove(e) {
      if (dragObj) {
        const rect = workArea.getBoundingClientRect();
        let x = (e.clientX - rect.left - offsetX) / scale;
        let y = (e.clientY - rect.top - offsetY) / scale;
        
        // Limitar movimento dentro da √°rea de trabalho
        const maxX = (workArea.parentElement.clientWidth / scale) - 60;
        const maxY = (workArea.parentElement.clientHeight / scale) - 30;
        
        x = Math.max(0, Math.min(maxX, x));
        y = Math.max(0, Math.min(maxY, y));
        
        dragObj.style.left = x + 'px';
        dragObj.style.top = y + 'px';
        redrawWires();
      } else if (isPanning) {
        translateX = e.clientX - startX;
        translateY = e.clientY - startY;
        updateWorkAreaTransform();
      }
    }

    function handleMouseUp(e) {
      // Nada espec√≠fico a fazer no mouseup local
    }

    function handleGlobalMouseUp(e) {
      dragObj = null;
      isPanning = false;
    }

    function connectPoints(a, b) {
      // Verificar se j√° existe uma conex√£o entre esses pontos
      const existingConnection = connections.find(conn => 
        (conn.a === a && conn.b === b) || (conn.a === b && conn.b === a)
      );
      
      if (existingConnection) {
        output.textContent = 'Esses pontos j√° est√£o conectados!';
        return;
      }
      
      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line.setAttribute('stroke', '#0fa3ff');
      line.setAttribute('stroke-width', '3');
      line.setAttribute('class', 'wire');
      svg.appendChild(line);
      connections.push({a, b, line});
      redrawWires();
      
      // Efeito visual
      line.classList.add('wire-highlight');
      setTimeout(() => line.classList.remove('wire-highlight'), 500);
      
      output.textContent = `Conex√£o estabelecida entre os pontos. Total de conex√µes: ${connections.length}`;
    }

    function redrawWires() {
      const rect = workArea.getBoundingClientRect();
      connections.forEach(c => {
        const ra = c.a.getBoundingClientRect();
        const rb = c.b.getBoundingClientRect();
        const x1 = ra.left + ra.width/2 - rect.left;
        const y1 = ra.top + ra.height/2 - rect.top;
        const x2 = rb.left + rb.width/2 - rect.left;
        const y2 = rb.top + rb.height/2 - rect.top;
        c.line.setAttribute('x1', x1);
        c.line.setAttribute('y1', y1);
        c.line.setAttribute('x2', x2);
        c.line.setAttribute('y2', y2);
      });
    }

    function addComponent(type, value, x, y) {
      compCount++;
      const c = document.createElement('div');
      c.className = `component ${type}`;
      c.dataset.id = compCount;
      c.dataset.type = type;
      c.dataset.value = value;
      
      const icon = document.createElement('div');
      icon.className = 'component-icon';
      icon.textContent = componentIcons[type];
      
      const label = document.createElement('div');
      label.textContent = `${type[0].toUpperCase()}${compCount}`;
      
      c.appendChild(icon);
      c.appendChild(label);
      
      // Adicionar efeito de luz para l√¢mpadas
      if (type === 'lamp') {
        const light = document.createElement('div');
        light.className = 'lamp-light';
        light.style.width = '60px';
        light.style.height = '60px';
        light.style.left = '-10px';
        light.style.top = '-10px';
        c.appendChild(light);
      }
      
      if (type === 'switch' || type === 'diode') {
        c.dataset.state = (type === 'switch' ? 'closed' : 'forward');
        c.addEventListener('dblclick', () => {
          if (type === 'switch') {
            c.dataset.state = c.dataset.state === 'closed' ? 'open' : 'closed';
            c.style.backgroundColor = c.dataset.state === 'closed' ? '#2980b9' : '#7f8c8d';
            
            // Efeito de fa√≠sca ao alternar interruptor
            if (animationEnabled) {
              createSpark(c);
            }
            
            output.textContent = `Interruptor ${c.dataset.id} agora est√° ${c.dataset.state === 'closed' ? 'fechado' : 'aberto'}`;
          } else {
            c.dataset.state = c.dataset.state === 'forward' ? 'reverse' : 'forward';
            c.style.backgroundColor = c.dataset.state === 'forward' ? '#d35400' : '#7f8c8d';
            output.textContent = `Diodo ${c.dataset.id} agora est√° em polariza√ß√£o ${c.dataset.state === 'forward' ? 'direta' : 'reversa'}`;
          }
        });
      }
      
      c.style.left = x + 'px'; 
      c.style.top = y + 'px';
      
      // Adicionar sockets de conex√£o
      ['pin1','pin2'].forEach(pin => {
        const s = document.createElement('div');
        s.className = `socket ${pin}`;
        c.appendChild(s);
      });
      
      // Tooltip interativo
      c.addEventListener('mouseenter', e => {
        let tip = `${type.toUpperCase()} #${c.dataset.id}\nValor: ${c.dataset.value}`;
        if (c.dataset.state) tip += `\nEstado: ${c.dataset.state}`;
        if (type === 'resistor' || type === 'lamp') tip += ' Œ©';
        else if (type === 'voltage') tip += ' V';
        else if (type === 'current') tip += ' A';
        else if (type === 'capacitor') tip += ' F';
        else if (type === 'inductor') tip += ' H';
        else if (type === 'diode') tip += ' V';
        
        tooltip.textContent = tip;
        tooltip.style.display = 'block';
      });
      
      c.addEventListener('mousemove', e => {
        tooltip.style.left = e.pageX + 10 + 'px';
        tooltip.style.top = e.pageY + 10 + 'px';
      });
      
      c.addEventListener('mouseleave', () => tooltip.style.display = 'none');
      
      workArea.appendChild(c);
      
      // Efeito visual ao adicionar
      c.classList.add('pulse');
      
      output.textContent = `${type} #${compCount} adicionado com valor ${value}`;
    }

    function removeComponent(el) {
      const sockets = Array.from(el.querySelectorAll('.socket'));
      
      // Remover conex√µes relacionadas a este componente
      for (let i = connections.length - 1; i >= 0; i--) {
        if (sockets.includes(connections[i].a) || sockets.includes(connections[i].b)) {
          connections[i].line.remove();
          connections.splice(i, 1);
        }
      }
      
      // Efeito visual ao remover
      el.style.transform = 'scale(0.5)';
      el.style.opacity = '0';
      setTimeout(() => {
        el.remove();
        output.textContent = `Componente ${el.dataset.type} #${el.dataset.id} removido`;
      }, 300);
    }

    function removeNode(node) {
      // Remover conex√µes relacionadas a este n√≥
      for (let i = connections.length - 1; i >= 0; i--) {
        if (connections[i].a === node || connections[i].b === node) {
          connections[i].line.remove();
          connections.splice(i, 1);
        }
      }
      
      // Efeito visual ao remover
      node.style.transform = 'scale(0.5)';
      node.style.opacity = '0';
      setTimeout(() => {
        node.remove();
        output.textContent = 'N√≥ removido';
      }, 300);
    }

    function removeConnectionsFromSocket(socket) {
      // Remover conex√µes relacionadas a este socket
      for (let i = connections.length - 1; i >= 0; i--) {
        if (connections[i].a === socket || connections[i].b === socket) {
          // Efeito visual ao remover
          connections[i].line.style.strokeWidth = '6';
          connections[i].line.style.stroke = '#e74c3c';
          setTimeout(() => {
            connections[i].line.remove();
            connections.splice(i, 1);
            output.textContent = 'Conex√£o removida';
          }, 300);
        }
      }
    }

    // Anima√ß√£o de el√©trons
    function startAnimations(simulation) {
      if (!animationEnabled) return;
      
      stopAnimations();
      currentSimulation = simulation;
      
      // Criar el√©trons para cada conex√£o com corrente
      connections.forEach(connection => {
        if (simulation.circuitCurrent > 0) {
          createElectronsForConnection(connection);
        }
      });
      
      // Atualizar estado das l√¢mpadas
      document.querySelectorAll('.component.lamp').forEach(lamp => {
        const comp = simulation.comps.find(c => c.id === lamp.dataset.id);
        if (comp && comp.current > 0) {
          lamp.classList.add('lamp-on');
        } else {
          lamp.classList.remove('lamp-on');
        }
      });
    }
    
    function stopAnimations() {
      // Remover todos os el√©trons
      document.querySelectorAll('.electron').forEach(electron => {
        electron.remove();
      });
      
      // Desligar todas as l√¢mpadas
      document.querySelectorAll('.lamp-on').forEach(lamp => {
        lamp.classList.remove('lamp-on');
      });
      
      if (animationInterval) {
        clearInterval(animationInterval);
        animationInterval = null;
      }
    }
    
    function createElectronsForConnection(connection) {
      if (!animationEnabled) return;
      
      const rect = workArea.getBoundingClientRect();
      const ra = connection.a.getBoundingClientRect();
      const rb = connection.b.getBoundingClientRect();
      
      const x1 = ra.left + ra.width/2 - rect.left;
      const y1 = ra.top + ra.height/2 - rect.top;
      const x2 = rb.left + rb.width/2 - rect.left;
      const y2 = rb.top + rb.height/2 - rect.top;
      
      // Calcular dire√ß√£o e dist√¢ncia
      const dx = x2 - x1;
      const dy = y2 - y1;
      const distance = Math.sqrt(dx*dx + dy*dy);
      
      // Criar m√∫ltiplos el√©trons
      const electronCount = Math.min(10, Math.max(3, Math.floor(distance / 30)));
      
      for (let i = 0; i < electronCount; i++) {
        setTimeout(() => {
          if (!animationEnabled) return;
          
          const electron = document.createElement('div');
          electron.className = 'electron electron-flow';
          electron.style.left = `${x1}px`;
          electron.style.top = `${y1}px`;
          electron.style.setProperty('--tx', `${dx}px`);
          electron.style.setProperty('--ty', `${dy}px`);
          
          // Atraso aleat√≥rio para criar efeito mais natural
          electron.style.animationDelay = `${Math.random() * 0.5}s`;
          
          document.getElementById('canvas-container').appendChild(electron);
          
          // Remover el√©tron ap√≥s a anima√ß√£o
          setTimeout(() => {
            if (electron.parentNode) {
              electron.remove();
            }
          }, 2000);
        }, i * 200);
      }
      
      // Continuar criando el√©trons
      animationInterval = setInterval(() => {
        if (!animationEnabled) return;
        createElectronsForConnection(connection);
      }, electronCount * 200 + 1000);
    }
    
    function createSpark(component) {
      const rect = component.getBoundingClientRect();
      const spark = document.createElement('div');
      spark.className = 'spark spark-effect';
      spark.style.left = `${rect.left + rect.width/2}px`;
      spark.style.top = `${rect.top + rect.height/2}px`;
      
      document.getElementById('canvas-container').appendChild(spark);
      
      // Remover fa√≠sca ap√≥s a anima√ß√£o
      setTimeout(() => {
        if (spark.parentNode) {
          spark.remove();
        }
      }, 300);
    }

    // Simula√ß√£o do circuito
    btnSim.onclick = () => {
      const comps = Array.from(workArea.children)
        .filter(c => c.classList.contains('component'))
        .map(c => ({
          id: c.dataset.id,
          type: c.dataset.type,
          value: parseFloat(c.dataset.value) || 0,
          state: c.dataset.state || 'forward'
        }));
      
      if (comps.length === 0) {
        output.textContent = 'Erro: Nenhum componente no circuito. Adicione componentes primeiro.';
        return;
      }
      
      const voltageSources = comps.filter(c => c.type === 'voltage');
      const currentSources = comps.filter(c => c.type === 'current');
      
      if (voltageSources.length === 0 && currentSources.length === 0) {
        output.textContent = 'Erro: Adicione pelo menos uma fonte de tens√£o ou corrente.';
        return;
      }
      
      // C√°lculo simplificado para circuito s√©rie
      let Rtotal = 0;
      let Vtotal = voltageSources.reduce((sum, src) => sum + src.value, 0);
      let diodeVoltageDrop = 0;
      let isCircuitOpen = false;
      
      // Identificar componentes que abrem o circuito
      comps.forEach(comp => {
        if (comp.type === 'capacitor') isCircuitOpen = true;
        if (comp.type === 'diode' && comp.state === 'reverse') isCircuitOpen = true;
        if (comp.type === 'switch' && comp.state === 'open') isCircuitOpen = true;
      });
      
      // Calcular resist√™ncia total e queda de tens√£o em diodos
      comps.forEach(comp => {
        if (comp.type === 'resistor' || comp.type === 'lamp') {
          Rtotal += comp.value;
        } else if (comp.type === 'diode' && comp.state === 'forward') {
          diodeVoltageDrop += comp.value;
        }
      });
      
      // Calcular corrente (Lei de Ohm)
      let circuitCurrent = 0;
      if (!isCircuitOpen && Rtotal > 0) {
        circuitCurrent = (Vtotal - diodeVoltageDrop) / Rtotal;
      }
      
      // Gerar relat√≥rio
      let report = `=== AN√ÅLISE DO CIRCUITO ===\n\n`;
      report += `Fontes de Tens√£o: ${voltageSources.length} (Total: ${Vtotal.toFixed(2)} V)\n`;
      report += `Fontes de Corrente: ${currentSources.length}\n`;
      report += `Resist√™ncia Total: ${Rtotal.toFixed(2)} Œ©\n`;
      report += `Queda de Tens√£o em Diodos: ${diodeVoltageDrop.toFixed(2)} V\n`;
      report += `Circuito ${isCircuitOpen ? 'ABERTO' : 'FECHADO'}\n`;
      report += `Corrente do Circuito: ${circuitCurrent.toFixed(4)} A\n\n`;
      report += `=== TENS√ïES E CORRENTES ===\n\n`;
      
      comps.forEach(comp => {
        let voltage = 0;
        let current = circuitCurrent;
        let power = 0;
        
        switch(comp.type) {
          case 'resistor':
          case 'lamp':
            voltage = circuitCurrent * comp.value;
            power = voltage * circuitCurrent;
            break;
            
          case 'voltage':
            voltage = comp.value;
            power = voltage * circuitCurrent;
            break;
            
          case 'current':
            current = comp.value;
            // Para fonte de corrente, a tens√£o depende do resto do circuito
            voltage = current * Rtotal;
            power = voltage * current;
            break;
            
          case 'capacitor':
            voltage = isCircuitOpen ? Vtotal : 0;
            current = isCircuitOpen ? 0 : circuitCurrent;
            break;
            
          case 'inductor':
            // Em DC, indutor √© curto-circuito
            voltage = 0;
            break;
            
          case 'diode':
            if (comp.state === 'forward') {
              voltage = comp.value;
              current = circuitCurrent;
            } else {
              voltage = Vtotal;
              current = 0;
            }
            power = voltage * current;
            break;
            
          case 'switch':
            if (comp.state === 'open') {
              voltage = Vtotal;
              current = 0;
            } else {
              voltage = 0;
              current = circuitCurrent;
            }
            break;
            
          case 'ground':
            voltage = 0;
            break;
        }
        
        report += `${comp.type.toUpperCase()} #${comp.id}:\n`;
        report += `  Tens√£o: ${voltage.toFixed(2)} V\n`;
        report += `  Corrente: ${current.toFixed(4)} A\n`;
        if (power > 0) {
          report += `  Pot√™ncia: ${power.toFixed(4)} W\n`;
        }
        report += `\n`;
      });
      
      output.textContent = report;
      
      // Iniciar anima√ß√µes
      const simulation = {
        comps: comps,
        circuitCurrent: circuitCurrent,
        isCircuitOpen: isCircuitOpen
      };
      
      startAnimations(simulation);
      
      // Efeito visual na simula√ß√£o
      btnSim.classList.add('pulse');
      setTimeout(() => btnSim.classList.remove('pulse'), 500);
    };

    // Inicializa√ß√£o
    updateWorkAreaTransform();
    
    // Adicionar instru√ß√µes iniciais
    output.textContent = `Bem-vindo ao Simulador de Circuitos!

Instru√ß√µes:
1. Toque em um componente na barra
2. Toque na √°rea para adicionar
3. Use "Fio" para conectar
4. Toque em "Simular" para analisar

Dica: Toque duplo em interruptores e diodos para alterar estado.`;
  });
  </script>
</body>
</html>